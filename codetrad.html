<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JSON API</title>
</head>
<body style="background: #000; color: #fff; margin: 0; padding: 0; font-family: monospace;">
    <script>
        /**
         * Affiche uniquement le texte JSON brut sur la page
         */
        function renderRawJson(data) {
            document.body.innerText = JSON.stringify(data);
        }

        async function handleRequest() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('key');
            const src = urlParams.get('src');
            const tgt = urlParams.get('tgt');
            const code = urlParams.get('code');

            if (!apiKey || !src || !tgt || !code) {
                renderRawJson({ 
                    status: "error", 
                    message: "Missing parameters. Required: ?key=...&src=...&tgt=...&code=..." 
                });
                return;
            }

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const prompt = `Translate this code from ${src} to ${tgt}. Output ONLY the raw translated code without any markdown formatting, backticks or explanations. Code: \n${code}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'Gemini API Error');

                let translatedCode = data.candidates[0].content.parts[0].text;
                // Nettoyage final pour extraire le code pur
                translatedCode = translatedCode.replace(/^```[a-z]*\n/i, '').replace(/\n```$/, '').trim();

                renderRawJson({
                    status: "success",
                    source: src,
                    target: tgt,
                    translation: translatedCode
                });
            } catch (err) {
                renderRawJson({
                    status: "error",
                    message: err.message
                });
            }
        }

        window.onload = handleRequest;
    </script>
</body>
</html>
